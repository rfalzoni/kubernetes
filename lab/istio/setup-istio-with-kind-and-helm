#!/bin/bash

# Create Kind Cluser
echo "Creating Kind Cluster..."
kubectl config get-contexts kind-istio &> /dev/null || \
./kind/cluster-creation.sh &> /dev/null

# Configure Helm Repo
helm repo add istio https://istio-release.storage.googleapis.com/charts &> /dev/null
helm repo update istio &> /dev/null

# Install istio-base (CRDs)
echo "Installing istio/base..."
helm upgrade \
  --install \
  --namespace "istio-system" \
  --create-namespace \
  istio-base istio/base > /dev/null

# Install Istio Discovery
echo "Installing istio/istiod..."
helm upgrade \
  --install \
  --namespace "istio-system" \
  --create-namespace \
  istio-discovery istio/istiod \
  --values "./helm/istio-discovery/mesh-config.yaml" \
  --wait > /dev/null

# Install Istio Ingress Gateway
echo "Installing istio/gateway..."
kubectl apply \
  --filename "./helm/istio-ingress/namespace.yaml" > /dev/null

helm upgrade \
  --install \
  --namespace "istio-ingress" \
  istio-ingress istio/gateway \
  --values "./helm/istio-ingress/service.yaml" > /dev/null

# Configure Telemetry
echo "Configuring Istio Telemetry..."
kubectl apply \
  --filename "./deployments/telemetry.yaml" > /dev/null

# Install cert-manager
echo "Installing cert-manager..."
helm upgrade \
  --install \
  --namespace cert-manager \
  --create-namespace \
  cert-manager cert-manager/cert-manager \
  --set "installCRDs=true" > /dev/null

kubectl apply \
  --filename "./helm/cert-manager/cluster-issuer.yaml" > /dev/null

# httpbin Self Signed Certificate
echo "Issuing a Self Signed Certificate..."
kubectl \
  --namespace istio-ingress \
  apply \
  --filename "./helm/istio-ingress/httpbin-certificate.yaml" > /dev/null

# httpbin Deploy
echo "Deploying httpbin..."
kubectl apply \
  --filename "./deployments/httpbin/namespace.yaml" > /dev/null && \
kubectl \
  --namespace httpbin \
  apply --filename "./deployments/httpbin/" > /dev/null && \
kubectl \
  --namespace httpbin \
  wait deployment httpbin \
  --for=condition=Available \
  --timeout=360s > /dev/null

kubectl apply \
  --filename "./deployments/httpbin-istio/" > /dev/null
