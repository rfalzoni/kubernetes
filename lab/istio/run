#!/bin/bash
kubectl config get-contexts kind-istio &> /dev/null || \
./kind-cluster-creation.sh

echo ""

helm repo add istio https://istio-release.storage.googleapis.com/charts &> /dev/null
helm repo update istio &> /dev/null
helm search repo istio/

echo ""

helm upgrade \
  --install \
  --namespace istio-system \
  --create-namespace \
  istio-base istio/base

echo ""

helm upgrade \
  --install \
  --namespace istio-system \
  --create-namespace \
  istio-discovery istio/istiod \
  --wait

echo ""

cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Namespace
metadata:
  name: istio-ingress
  labels:
    istio-injection: enabled
EOF

echo ""

helm upgrade \
  --install \
  --namespace istio-ingress \
  istio-ingress istio/gateway \
  --values helm/service.yaml

echo ""

cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Namespace
metadata:
  name: httpbin
  labels:
    istio-injection: enabled
EOF

kubectl \
  --namespace httpbin \
  apply -f httpbin/ && \
kubectl \
  --namespace httpbin \
  wait deployment httpbin \
  --for=condition=Available \
  --timeout=360s

kubectl \
  --namespace httpbin \
  get deployment,pods,services
