#!/bin/bash
kind/create

kubectl create namespace wasp

kubectl apply \
  --namespace wasp \
  --filename - <<EOF
---
apiVersion: v1
kind: Secret
metadata:
  name: mongoshell
type: Opaque
stringData:
  MONGODB_HOST:          ${MONGODB_HOST}
  MONGODB_DATABASE_NAME: ${MONGODB_DATABASE_NAME}
  MONGODB_USERNAME:      ${MONGODB_USERNAME}
  MONGODB_PASSWORD:      ${MONGODB_PASSWORD}
EOF

# Define Node Name
export NODE_NAME="aks-userpool1-33333333-vmss000001"

# Create POD
envsubst < "deploy/pod.yaml" | \
kubectl apply \
  --namespace wasp \
  --filename - && \
kubectl wait pod mongoshell \
  --for condition=Ready \
  --timeout 120s \
  --namespace wasp

# mongodb shell container
kubectl exec mongoshell \
  --namespace wasp \
  --container "mongoshell" \
  --stdin \
  --tty -- /bin/bash

/opt/mongodb/entrypoint \
  --command 'printjson(db.accounts.find( { "account_id": 702610 } ))' \
  --debug 0

# nsenter container
kubectl exec mongoshell \
  --namespace wasp \
  --container "nsenter" \
  --stdin \
  --tty -- /bin/bash

tcpdump --version || (apt-get update && apt-get install tcpdump --yes)

# commands
tcpdump -D
tcpdump --interface eth0 -w network.pcap
tcpdump --interface any -w network.pcap
tcpdump --interface any dst port 27017 -w network.pcap
tcpdump --interface any -nn -vvv

# AKS Node Debug
# https://learn.microsoft.com/en-us/azure/aks/node-access#create-an-interactive-shell-connection-to-a-linux-node
kubectl debug node/${NODE_NAME?} \
  -it \
  --image=mcr.microsoft.com/dotnet/runtime-deps:6.0

chroot /host

mtr -rTc 50 ${MONGODB_HOST?}

# copy file to localhost (stop tcpdump before run this)
kubectl --namespace wasp cp --container nsenter mongoshell:'/data/network.pcap' network.pcap

kubectl cp node-debugger-aks-userpool1-33137823-vmss000027-5l45p:'/host/network.pcap' network.pcap

# read
tcpdump -r network.pcap

# wireshark (select yes to run as non super user)
sudo apt update
sudo apt install wireshark
sudo usermod -aG wireshark $(whoami)
# sudo reboot

# DNS Lookup
dig ${MONGODB_HOST?} SRV

# SRV Lookup DNS Entries
pip3 install srvlookup

# python3 mongodb_srv_records.py cluster0.qq6tuw6.mongodb.net
python3 mongodb_srv_records.py ${MONGODB_HOST?}
